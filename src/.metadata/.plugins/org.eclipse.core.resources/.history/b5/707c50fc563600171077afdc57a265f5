package classifier;

import java.io.File;
import java.io.IOException;
import java.util.Random;
import java.util.logging.Level;
import java.util.logging.Logger;

public class DigraphOutputWorker implements Runnable {
	private String outputDir;
	private File[] files;
	
    private static Random random = new Random();
    
    public static final int TARGET_SAMPLE_COUNT = 100;
    
	public DigraphOutputWorker(File dir) {
		files = dir.listFiles();
		outputDir = "output/" + dir.getName() + "/";
		File file = new File(outputDir);
		file.mkdirs();
		
			
	}

	@Override
	public void run() {
	    
        if(output == null) {
            if(handler!=null) handler.onFinished();
            return;
        }
        
        int i=-1;
        
        int maxAttempt;
        
        while(++i<files.length && count < TARGET_SAMPLE_COUNT) {
            File curFile = files[i];
            BufferedFile file = BufferedFile.open(curFile.getAbsolutePath());
            if(file == null) {
                System.out.println("Cannot open file " + curFile.getAbsolutePath());
                
                continue;
            }
            
            if(file.getLength()<8192) {
                System.out.println("File too small: " + curFile.getAbsolutePath());
                file.close();
                continue;
            }
            
            maxAttempt = 10; // can change this based on size of file
            
            for(int attempt = 0;attempt<maxAttempt;attempt++) {
                int x = (int)(random.nextDouble() * (file.getLength()-8192));
                file.setOffset(x);
                
                if(file.getPercentageZero() <0.995 && file.getPercentageZero()>0.005) {
                    try {
                        output.write(file.getDigraph());
                        count++;
                    } catch (IOException ex) {
                        Logger.getLogger(DirectoryWorker.class.getName()).log(Level.SEVERE, null, ex);
                        break;
                    }
                }
            }
            
            file.close();
            
            System.out.println(Thread.currentThread().getName() + ": " + count + "/" + TARGET_SAMPLE_COUNT);
        }
        
        try {
            output.close();
        } catch (IOException ex) {
            Logger.getLogger(DirectoryWorker.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        if(handler!=null) handler.onFinished();
	}
}
